post:
  title: >-
    Issue [ TFS 2012.2 ] Detaching collection fails on SnapshotIdentities with
    object reference not set to an instance of an object
  link: >-
    https://nkdagility.com/blog/tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities/
  pubDate: Mon, 24 Jun 2013 09:35:36 +0000
  creator: MrHinsh
  guid:
    _: http://nakedalmweb.wpengine.com/?p=9661
    $:
      isPermaLink: 'false'
  description: ''
  encoded:
  - >-
    <p class="lead">When you try to detach a Team Project Collection in Team
    Foundation Server the process fails on SnapshotIdentities with an "object
    reference not set to an instance of an object" error. While this does not
    inhibit the execution of TFS there is likely a good reason that you wanted
    to detach and found this issue.  </p>

    <p><a href="http://nkdagility.com/files/2013/06/image131.png"><img
    title="image13" style="border-left-width: 0px; border-right-width: 0px;
    background-image: none; border-bottom-width: 0px; padding-top: 0px;
    padding-left: 0px; display: inline; padding-right: 0px; border-top-width:
    0px" border="0" alt="image13"
    src="https://nkdagility.com/files/2013/06/image13_thumb.png" width="800"
    height="500"/></a> <br /><small>Figure: object reference not set to an
    instance of an object</small></p>

    <p>In this case I was trying to move the Collection to another server and
    this is a blocking issue.</p>

    <h2>Applies To</h2>

    <ul>

    <li>Team Foundation Server 2012  </li>

    <li>Team Foundation Server 2012.1  </li>

    <li>Team Foundation Server 2012.2  </li>

    <li>Team Foundation Server 2012.3  </li>

    <li>Team Foundation Server 2013 Preview</li>

    </ul>

    <h2>Findings</h2>

    <p>When you get these sorts of errors make sure that you look in the Event
    Log of the server and at the logs generated by TFS. In the event of an error
    there will be a link on the page that will open the relevant log in the Team
    Foundation Server Administration Console.</p>

    <pre>[11:16:24.010] ++ Executing - Operation: Snapshot, Group:
    Snapshot.TfsIdentities

    [11:16:25.010] Executing step: Copy identities to collection database

    [11:16:25.010]   Executing step: 'Copy identities to collection database'
    Identity.SnapshotIdentities (16 of 28)

    [11:18:15.873]   [Error] Object reference not set to an instance of an
    object.

    [11:18:15.877]   System.NullReferenceException: Object reference not set to
    an instance of an object.

    [11:18:15.877]      at
    Microsoft.TeamFoundation.Framework.Server.IdentityTransferHandler.Transfer()

    [11:18:15.877]      at
    Microsoft.TeamFoundation.Framework.Server.IdentityTransferHandler.Execute()

    [11:18:15.877]      at
    Microsoft.VisualStudio.Services.Framework.IdentityStepPerformer.SnapshotIdentities(TeamFoundationRequestContext
    requestContext, ServicingContext servicingContext)

    [11:18:15.877]      at
    Microsoft.TeamFoundation.Framework.Server.TeamFoundationStepPerformerBase.Microsoft.TeamFoundation.Framework.Server.IStepPerformer.PerformStep(String
    servicingOperation, String stepType, String stepData, ServicingContext
    servicingContext)

    [11:18:15.877]      at
    Microsoft.TeamFoundation.Framework.Server.ServicingStepDriver.PerformServicingStep(ServicingStep
    step, ServicingContext servicingContext, ServicingStepGroup group,
    ServicingOperation servicingOperation, Int32 stepNumber, Int32 totalSteps)

    [11:18:15.877] Step failed: Copy identities to collection database.
    Execution time: 110 seconds.

    [11:18:15.883]   Clearing dictionary, removing all items.

    </pre>

    <p>In the log you can clearly see that the step that is failing is the
    “Snapshot.TfsIdentities”. What I believe that this does is create a package
    inside of the Collection database for the new TFS Instance that you are
    moving it to. This package needs to contain all of the Identities that have
    interacted with this TFS Instance. The likely cause of this error is that
    there are orphaned group memberships in the Configuration database that do
    not exist within the Collection.</p>

    <p>I would suggest that this would be the result of a TFS server that has
    backed up without the use of a ‘marked transaction log’ and that backup
    restored at some point. If you have large databases and you don't use the <a
    href="http://msdn.microsoft.com/en-us/library/vstudio/hh561429.aspx"
    target="_blank">built in Scheduled Backups tool</a> or the documented
    process to <a
    href="http://msdn.microsoft.com/en-us/library/vstudio/ms253070.aspx">manually
    back up Team Foundation Server</a> then you are leaving yourself open for
    this type of inconsistency.</p>

    <p>To find out if your have any orphaned identities then you should run:</p>

    <p><em><spam class="label label-warning">Warning</spam> Do not make any
    changes to any of your TFS Databases manually unless specifically instructed
    by the Product Team. If you do then you can no longer be supported by
    Microsoft.</em></p>

    <pre>SELECT  gm

    FROM    tbl_GroupMembership gm

    WHERE   gm.PartitionId = 1
        AND NOT EXISTS (
            SELECT  *
            FROM    tbl_Group g
            WHERE   g.PartitionId = 1
                AND g.Id = gm.MemberId                       
        )
        AND NOT EXISTS (
            SELECT  *
            FROM    tbl_Identity i
            WHERE   i.PartitionId = 1
                AND i.Id = gm.MemberId
        )
    </pre>

    <p>If you get results from this query then you have this problem and you
    should immediately raise a support ticket with Microsoft to get this
    fixed.</p>

    <h2>Solution</h2>

    <p>You need to remove all of the orphaned identities from your server in
    order to fix this. To achieve that you should work with Microsoft by raising
    a support ticket and cleaning the instance.&nbsp; If an invalid backup has
    been restored there are likely other things that need to happen to get into
    a supported state and changing the database yourself will not get you there.
    </p>

    <p>Raise a ticket and get your server into a supported state…</p>

    <ul></ul>
  - >-
    <p class="lead">When you try to detach a Team Project Collection in Team
    Foundation Server the process fails on SnapshotIdentities with an "object
    reference not set to an instance of an object" error. While this does not
    inhibit the execution of TFS there is likely a good reason that you wanted
    to detach and found this issue.  </p>
  post_id: '9661'
  post_date: '2013-06-24 10:35:36'
  post_date_gmt: '2013-06-24 09:35:36'
  post_modified: '2013-06-24 10:35:36'
  post_modified_gmt: '2013-06-24 09:35:36'
  comment_status: open
  ping_status: open
  post_name: tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities
  status: publish
  post_parent: '0'
  menu_order: '0'
  post_type: post
  post_password: ''
  is_sticky: '0'
  category: {}
  postmeta:
  - meta_key: authorsure_include_css
    meta_value: ''
  - meta_key: _views_template
    meta_value: '0'
  - meta_key: _yoast_wpseo_linkdex
    meta_value: '79'
  - meta_key: _edit_last
    meta_value: '3'
  - meta_key: authorsure_include_css
    meta_value: ''
  - meta_key: _syn_old_sitegroups
    meta_value: a:0:{}
  - meta_key: _syn_selected_sitegroups
    meta_value: ''
  - meta_key: wp-to-buffer
    meta_value: a:1:{s:7:"publish";s:1:"1";}
  - meta_key: _mab_post_meta
    meta_value: >-
      a:2:{s:15:"post-action-box";s:7:"default";s:25:"post-action-box-placement";s:6:"bottom";}
  - meta_key: _yoast_wpseo_focuskw
    meta_value: SnapshotIdentities
  - meta_key: _yoast_wpseo_title
    meta_value: TFS 2012.2 Issue - Detaching collection fails on SnapshotIdentities
  - meta_key: _yoast_wpseo_metadesc
    meta_value: >-
      When you try to detach a Team Project Collection in Team Foundation Server
      the process fails on SnapshotIdentities with an "object reference not set
      to an instance of an object" error.
  - meta_key: _syn_slave_post_states
    meta_value: a:0:{}
  - meta_key: _thumbnail_id
    meta_value: '7145'
  - meta_key: _wpas_done_all
    meta_value: '1'
  - meta_key: wp-to-buffer-log
    meta_value: >-
      O:8:"stdClass":5:{s:7:"updates";a:3:{i:0;O:8:"stdClass":17:{s:3:"_id";s:24:"51c81352261ab20d3b0000a4";s:9:"client_id";s:24:"50f71563f758fa8f40000001";s:10:"created_at";i:1372066642;s:3:"day";s:5:"Today";s:6:"due_at";i:1372072200;s:8:"due_time";s:8:"12:10
      pm";s:2:"id";s:24:"51c81352261ab20d3b0000a4";s:10:"profile_id";s:24:"507a4e20d9320dd125000018";s:15:"profile_service";s:7:"twitter";s:10:"shared_now";b:0;s:6:"status";s:6:"buffer";s:4:"text";s:163:"New
      Post: Issue [ TFS 2012.2 ] Detaching collection fails on
      SnapshotIdentities with object reference not set to an instance of an
      object http://buff.ly/12cZSii…";s:14:"text_formatted";s:252:"New Post:
      Issue [ TFS 2012.2 ] Detaching collection fails on SnapshotIdentities with
      object reference not set to an instance of an object <a class="url"
      href="http://buff.ly/12cZSii" rel="external nofollow"
      target="_blank">http://buff.ly/12cZSii</a>…";s:4:"type";s:4:"link";s:10:"updated_at";i:1372066642;s:7:"user_id";s:24:"507a4e20d9320dd125000017";s:3:"via";s:3:"api";}i:1;O:8:"stdClass":18:{s:3:"_id";s:24:"51c81353261ab20d3b0000a5";s:9:"client_id";s:24:"50f71563f758fa8f40000001";s:10:"created_at";i:1372066643;s:3:"day";s:5:"Today";s:6:"due_at";i:1372118760;s:8:"due_time";s:7:"6:06
      pm";s:2:"id";s:24:"51c81353261ab20d3b0000a5";s:5:"media";O:8:"stdClass":5:{s:8:"original";s:88:"http://nkdagility.com/tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities/";s:11:"description";s:184:"When
      you try to detach a Team Project Collection in Team Foundation Server the
      process fails on SnapshotIdentities with an "object reference not set to
      an instance of an object" error.";s:5:"title";s:67:"TFS 2012.2 Issue -
      Detaching collection fails on
      SnapshotIdentities";s:4:"link";s:88:"http://nkdagility.com/tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities/";s:7:"preview";s:105:"http://i2.wp.com/nakedalmweb.wpengine.com/files/2012/08/puzzle-issue-problem-128-link.png?fit=1024%2C1024";}s:10:"profile_id";s:24:"5088ae7ed9320d615a00000a";s:15:"profile_service";s:8:"facebook";s:10:"shared_now";b:0;s:6:"status";s:6:"buffer";s:4:"text";s:167:"New
      Post: Issue [ TFS 2012.2 ] Detaching collection fails on
      SnapshotIdentities with object reference not set to an instance of an
      object http://buff.ly/12cZTCY #vsalm";s:14:"text_formatted";s:382:"New
      Post: Issue [ TFS 2012.2 ] Detaching collection fails on
      SnapshotIdentities with object reference not set to an instance of an
      object <a class="url" href="http://buff.ly/12cZTCY" rel="external
      nofollow" target="_blank">http://buff.ly/12cZTCY</a> <a
      href="https://twitter.com/#!/search?q=%23vsalm" title="#vsalm"
      class="hashtag" rel="external nofollow"
      target="_blank">#vsalm</a>";s:4:"type";s:4:"link";s:10:"updated_at";i:1372066643;s:7:"user_id";s:24:"507a4e20d9320dd125000017";s:3:"via";s:3:"api";}i:2;O:8:"stdClass":18:{s:3:"_id";s:24:"51c81353261ab20d3b0000a6";s:9:"client_id";s:24:"50f71563f758fa8f40000001";s:10:"created_at";i:1372066643;s:3:"day";s:5:"Today";s:6:"due_at";i:1372067340;s:8:"due_time";s:8:"10:49
      am";s:2:"id";s:24:"51c81353261ab20d3b0000a6";s:5:"media";O:8:"stdClass":5:{s:8:"original";s:88:"http://nkdagility.com/tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities/";s:11:"description";s:184:"When
      you try to detach a Team Project Collection in Team Foundation Server the
      process fails on SnapshotIdentities with an "object reference not set to
      an instance of an object" error.";s:5:"title";s:67:"TFS 2012.2 Issue -
      Detaching collection fails on
      SnapshotIdentities";s:4:"link";s:88:"http://nkdagility.com/tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities/";s:7:"preview";s:105:"http://i2.wp.com/nakedalmweb.wpengine.com/files/2012/08/puzzle-issue-problem-128-link.png?fit=1024%2C1024";}s:10:"profile_id";s:24:"5088ae96d9320d3a5a00000a";s:15:"profile_service";s:8:"linkedin";s:10:"shared_now";b:0;s:6:"status";s:6:"buffer";s:4:"text";s:167:"New
      Post: Issue [ TFS 2012.2 ] Detaching collection fails on
      SnapshotIdentities with object reference not set to an instance of an
      object http://buff.ly/12cZSim #vsalm";s:14:"text_formatted";s:382:"New
      Post: Issue [ TFS 2012.2 ] Detaching collection fails on
      SnapshotIdentities with object reference not set to an instance of an
      object <a class="url" href="http://buff.ly/12cZSim" rel="external
      nofollow" target="_blank">http://buff.ly/12cZSim</a> <a
      href="https://twitter.com/#!/search?q=%23vsalm" title="#vsalm"
      class="hashtag" rel="external nofollow"
      target="_blank">#vsalm</a>";s:4:"type";s:4:"link";s:10:"updated_at";i:1372066643;s:7:"user_id";s:24:"507a4e20d9320dd125000017";s:3:"via";s:3:"api";}}s:17:"buffer_percentage";i:10;s:12:"buffer_count";i:1;s:7:"success";b:1;s:7:"message";s:48:"One
      more post in your Buffer. Keep it topped up!";}
  - meta_key: dsq_thread_id
    meta_value: '1429807925'
  - meta_key: _wpbitly
    meta_value: http://nkdalm.net/1aCBa0A
  - meta_key: _jetpack_related_posts_cache
    meta_value: >-
      a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1474488360;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:9899;}i:1;a:1:{s:2:"id";i:9249;}i:2;a:1:{s:2:"id";i:9749;}}}}
  - meta_key: _wpghs_github_path
    meta_value: >-
      _posts/2013-06-24-tfs-2012-2-issue-detaching-collection-fails-on-snapshotidentities.md
  - meta_key: _sha
    meta_value: ''
  - meta_key: _wpml_media_has_media
    meta_value: '1'
  - meta_key: _tribe_ticket_capacity
    meta_value: '0'
  - meta_key: _tribe_ticket_version
    meta_value: 4.12.1.2
  - meta_key: ekit_post_views_count
    meta_value: '480'
