{{ if eq .Page.Params.ItemKind "resource" }}
  {{/* Count rendered headings across the page with unique namespace */}}
  {{ $scratchKey := printf "heading_count_%s" .Page.Params.ItemId }}
  {{ $n := default 0 (.Page.Scratch.Get $scratchKey) }}
  {{ $n = add $n 1 }}
  {{ .Page.Scratch.Set $scratchKey $n }}
  {{/* Decide whether to inject before the 3rd heading */}}
  {{- $relatedMarketing := partial "functions/get-related-as-pages.html" (dict "Page" .Page "EntryKind" "marketing") }}
  {{ $totalItems := len $relatedMarketing }}
  {{- if eq hugo.Environment "development" }}
    <div>[Heading {{ $n }} - Related*{{ $totalItems }}]</div>
  {{- end }}
  {{- if and (eq (mod $n 3) 0) (le (div $n 3) $totalItems) }}
    {{ $index := sub (div $n 3) 1 }}
    {{ $item := index $relatedMarketing $index }}
    <aside class="marketing-callout">
      <p class="small text-secondary mb-2"><strong>NKD Agility</strong> helps teams implement the ideas discussed in this article with</p>
      <h4 class="marketing-callout__title">ðŸš€ {{ $item.Title }}</h4>
      {{- if $item.Description }}
        <p class="marketing-callout__description">{{ $item.Description }}</p>
      {{- end }}
      <a href="{{ $item.RelPermalink }}" class="marketing-callout__link">Learn more â†’</a>
    </aside>
  {{- end }}

  {{- if eq $totalItems 0 }}
    <aside class="marketing-callout marketing-callout-NoRelated">
      <p class="small text-secondary mb-2"><strong>NKD Agility</strong> helps teams implement the ideas discussed in this article with</p>
      <h4 class="marketing-callout__title">ðŸš€ Technical Leadership in One Hour a Week</h4>
      <p class="marketing-callout__description">A practical guide to effective technical leadership, offering strategies and tips for making a meaningful impact with just one hour of focused effort each week.</p>
      <a href="/capabilities/technical-leadership-in-one-hour-a-week/#default" class="marketing-callout__link">Learn more â†’</a>
    </aside>
  {{- end }}
{{- end }}
