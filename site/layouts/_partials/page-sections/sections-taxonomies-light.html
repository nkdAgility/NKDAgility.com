{{- $site := .site }}
{{- $context := .context }}
<!-- Generic taxonomy rendering -->
<div class="container-fluid">
  <!-- Collect and group content by taxonomy terms -->
  {{- $contentByTaxonomy := dict }}
  {{- range $taxonomyName, $terms := .site.Taxonomies }}
    {{- if eq $taxonomyName $context.source }}
      {{- range $terms.ByCount }}
        {{- $matchingPages := where .Pages "Type" "in" $context.types }}
        {{- if and (gt (len .Pages) 0) (gt (len $matchingPages) 0) }}
          {{- $pagesToDisplay := .Pages.ByWeight }}
          {{- if $context.types }}
            {{- $pagesToDisplay = where .Pages.ByWeight "Type" "in" $context.types }}
          {{- end }}
          {{- range $item := $pagesToDisplay }}
            {{- $taxonomyValues := index $item.Params $context.source }}
            {{- $taxonomyTerm := "Other" }}
            {{- if $taxonomyValues }}
              {{- $taxonomyTerm = index $taxonomyValues 0 }}
            {{- end }}
            {{- $termContent := index $contentByTaxonomy $taxonomyTerm | default slice }}
            {{- $contentData := dict "item" $item "category" .Page.Title }}
            {{- $termContent = $termContent | append $contentData }}
            {{- $contentByTaxonomy = merge $contentByTaxonomy (dict $taxonomyTerm $termContent) }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}


  <!-- Display content grouped by taxonomy terms (sorted by content count, descending) -->
  {{- $sortedTaxonomyTerms := slice }}
  {{- range $taxonomyTerm, $content := $contentByTaxonomy }}
    {{- $termData := dict "term" $taxonomyTerm "content" $content "count" (len $content) }}
    {{- $sortedTaxonomyTerms = $sortedTaxonomyTerms | append $termData }}
  {{- end }}
  {{- $sortedTaxonomyTerms = sort $sortedTaxonomyTerms "count" "desc" }}

  {{- range $termData := $sortedTaxonomyTerms }}
    {{- $taxonomyTerm := $termData.term }}
    {{- $content := $termData.content }}
    {{- $sortedContent := sort $content "item.Weight" "asc" }}
    <div class="mb-4">
      <!-- Taxonomy Term Header -->
      <div class="row py-3 mb-3 rounded align-items-center" style="background-color: var(--primary-color-background); color: var(--primary-color-text);">
        <div class="col-md-8 col-12">
          <h5 class="mb-0 fw-bold" style="color: var(--primary-color-text);">{{ $taxonomyTerm }}</h5>
        </div>
        <div class="col-md-4 col-12 text-md-end">
          <small style="color: rgba(255, 255, 255, 0.8);">{{ len $content }} item{{ if ne (len $content) 1 }}s{{ end }}</small>
        </div>
      </div>

      <!-- Content Rows for this taxonomy term (first 3 only) -->
      {{- range $contentData := first 3 $sortedContent }}
        <div class="row border-bottom py-2 align-items-center">
          <div class="col-md-7 col-12 mb-1 mb-md-0">
            <a href="{{- $contentData.item.Permalink }}" class="text-decoration-none fw-semibold" title="{{- $contentData.item.Title }}">
              {{- if $contentData.item.Params.short_title }}
                {{- $contentData.item.Params.short_title }}
              {{- else }}
                {{- $contentData.item.Title }}
              {{- end }}
            </a>
          </div>
          <div class="col-md-5 col-12">
            {{- $deliveryAudiences := index $contentData.item.Params "delivery-audiences" }}
            {{- if $deliveryAudiences }}
              {{- range $index, $audience := first 2 $deliveryAudiences }}
                <span class="badge bg-light text-dark me-1 mb-1 small">{{ $audience }}</span>
              {{- end }}
              {{- if gt (len $deliveryAudiences) 2 }}
                <span class="text-muted small">+{{ sub (len $deliveryAudiences) 2 }} more</span>
              {{- end }}
            {{- else }}
              <span class="text-muted small">Not specified</span>
            {{- end }}
          </div>
        </div>
      {{- end }}


      <!-- More button if there are more than 3 items -->
      {{- if gt (len $content) 3 }}
        <div class="row mt-3">
          <div class="col-12 text-end">
            {{- $termSlug := $taxonomyTerm | urlize }}
            <a href="/capabilities/training-courses/{{ $context.source }}/{{ $termSlug }}/" class="btn btn-outline-primary btn-sm"> View all {{ len $content }} {{ $taxonomyTerm }} items <i class="fa-solid fa-arrow-right ms-1"></i> </a>
          </div>
        </div>
      {{- end }}
    </div>
  {{- end }}
</div>
