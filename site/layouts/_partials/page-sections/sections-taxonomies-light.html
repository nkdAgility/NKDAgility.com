{{- $site := .site }}
{{- $context := .context }}
<!-- Courses specific rendering -->
<div class="row">
  {{- range $taxonomyName, $terms := .site.Taxonomies }}
    {{- if eq $taxonomyName $context.source }}
      {{- $filteredTerms := slice }}
      {{- range $terms.ByCount }}
        {{- $matchingPages := where .Pages "Type" "in" $context.types }}
        {{- if and (gt (len .Pages) 0) (gt (len $matchingPages) 0) }}
          {{- $filteredTerms = $filteredTerms | append . }}
        {{- end }}
      {{- end }}
      {{- $sortedTerms := first 6 (sort $filteredTerms "Page.Weight" "desc") }}
      {{- $count := len $sortedTerms }}
      {{- $colClass := "col-lg-4" }}
      {{- if eq (mod $count 3) 0 }}
        {{- $colClass = "col-lg-4" }}
        <!-- 3 per row -->
      {{- else if eq (mod $count 2) 0 }}
        {{- $colClass = "col-lg-6" }}
        <!-- 2 per row -->
      {{- end }}
      {{- range $sortedTerms }}
        <div class="{{- $colClass }} col-sm-12 col-md-12 p-2 d-flex">
          {{- $pagesToDisplay := .Pages.ByWeight }}
          {{- if $context.types }}
            {{- $pagesToDisplay = where .Pages.ByWeight "Type" "in" $context.types }}
          {{- end }}
          <div class="m-2 card sectioncards m-3 shadow text-start flex-fill flex-grow-1 small border-0 h-100 position-relative">
            <div class="card-body p-4 px-20">
              <span class="badge text-bg-secondary"><i class="fa-regular fa-tag"></i> {{ title .Page.Type }}</span>
              <h3 class="ttl-nkdagility h5 text-start" title="{{- .Page.Title }}">
                {{- if .Page.Params.card }}
                  {{- .Page.Params.card.title }}
                {{- else }}
                  {{- .Page.Title }}
                {{- end }}
              </h3>
              <div class="card-text text-muted">
                {{- if .Page.Params.card }}
                  {{- .Page.Params.card.content | markdownify }}
                {{- else }}
                  {{- .Page.Content | markdownify }}
                {{- end }}
              </div>
            </div>
            <ul class="list-group list-group-flush">
              {{- range $item := first 5 $pagesToDisplay }}
                <li class="list-group-item d-flex align-items-center">
                  {{- if $item.Params.previewIcon }}
                    {{- $courseIcon := $item.Resources.GetMatch (printf "images/%s" $item.Params.previewIcon) }}
                    {{- if $courseIcon }}
                      {{- $resized := $courseIcon.Fit "25x25 webp" }}
                      <img class="shadowfilter me-2" loading="lazy" src="{{- $resized.RelPermalink }}" alt="{{- $item.Title }}" />
                    {{- end }}
                  {{- end }}
                  {{- if $item.Params.offering.courseIcon }}
                    {{- $courseIcon := $item.Resources.GetMatch (printf "images/%s" $item.Params.offering.courseIcon) }}
                    {{- if $courseIcon }}
                      {{- $resized := $courseIcon.Fit "25x25 webp" }}
                      <img class="shadowfilter me-2" loading="lazy" src="{{- $resized.RelPermalink }}" alt="{{- $item.Title }}" />
                    {{- end }}
                  {{- end }}
                  <a href="{{- $item.Permalink }}" class="text-decoration-none  text-nowrap text-truncate" title="{{- $item.Title }}">
                    {{- if $item.Params.short_title }}
                      {{- $item.Params.short_title }}
                    {{- else }}
                      {{- $item.Title }}
                    {{- end }}
                  </a>
                </li>
              {{- end }}
            </ul>
            {{- if .Page.RelPermalink }}
              <div class="card-footer border-transparent p-3 text-end border-0">
                {{- $itemString := delimit $context.types "," }}
                <a href="{{- .Page.RelPermalink }}?types={{- $itemString | urlquery }}" class="btn btn-nkdagility p-2" title="More information on {{- .Page.Title }}">See all <i class="fa-solid fa-arrow-right"></i></a>
              </div>
            {{- end }}
          </div>
        </div>
      {{- end }}
    {{- end }}
  {{- end }}
</div>
