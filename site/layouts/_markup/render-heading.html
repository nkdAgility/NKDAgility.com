{{/* Count rendered headings across the page */}}
{{ $n := default 0 (.Page.Scratch.Get "heading_count") }}
{{ $n = add $n 1 }}
{{ .Page.Scratch.Set "heading_count" $n }} 

{{/* Decide whether to inject before the 3rd heading */}}
{{ if eq $n 3 }}
{{- $relatedResources := partial "functions/get-related-as-pages.html" (dict "Page" .Page "EntryKind" "resource") }}
    {{- $relatedResources := where $relatedResources "Type" "ne" "guides" }}
    {{- $relatedResources := first 6 $relatedResources }}


    {{/*  <div class="injected">-------------------------------------TEST</div>  */}}
    {{ else}}
    {{/*  <div class="injected">-------------------------------------TEST {{ $n }}</div>  */}}
{{ end }} 

{{/* Render the actual heading (preserve id/anchor) */}}
<h{{ .Level }} id="{{ .Anchor }}">{{ .Text | safeHTML }}</h{{ .Level }}>