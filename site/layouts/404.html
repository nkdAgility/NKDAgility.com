{{- define "breadcrumbs" }}
  <div></div>
{{- end }}

{{- define "headline" }}
  <section class="container my-5">
    <div class="row p-2 p-lg-6">
      <div class="col-xl-6 p-lg-3">
        <h1 class="mb-4 nkda-heading-primary">404 Page not Found.</h1>
        <h2 class="mb-4 nkda-heading-secondary">Engineering Excellence: Minimising Errors, Maximising Outcomes</h2>
        <p class="mb-4 d-none d-sm-block text-muted">At Naked Agility, weâ€™re all about delivering robust solutions and measurable outcomes. While even the best systems occasionally hit a snag, we see every 404 as a chance to adapt and improve. Excellence isnâ€™t about perfectionâ€”itâ€™s about learning fast, fixing faster, and always striving for better. Letâ€™s get you back on track!</p>
        <h2 class="mb-4 nkda-heading-secondary">Spot a Problem? Letâ€™s Fix It Together!</h2>
        <p class="mb-4 d-none d-sm-block text-muted">
          Think youâ€™ve found a glitch? Head over to our
          <a href="https://github.com/nkdAgility/NKDAgility.com/issues" target="_blank">
            GitHub Issues&nbsp;<small><i class="fa-regular fa-arrow-up-right-from-square" style="transform: scale(0.6)"></i></small>
          </a>
          to report it â€” weâ€™re always keen to hear from you. Feeling adventurous? Submit a pull request and be part of the solution! Together, we can make things better. ðŸš€
        </p>
      </div>
      <div class="col-xl-4 d-none d-sm-block">
        <div class="row">
          <div class="col-12">
            <img src="/images/404.webp" />
          </div>
        </div>
        <div class="row p-5">
          <div class="col-lg-4 col-sm-6 col-md-4 p-2"><img src="/images/PST-Badge-v2-web-transparent.webp" loading="lazy" width="100%" /></div>
          <div class="col-lg-4 col-sm-6 col-md-4 p-2"><img src="/images/MVP_Horizontal_FullColor.webp" loading="lazy" width="100%" /></div>
          <div class="col-lg-4 col-sm-6 col-md-4 p-2"><img src="/images/PK-Email@0.5x-1.png" loading="lazy" width="100%" /></div>
        </div>
      </div>
    </div>
  </section>
{{- end }}

{{- define "main" }}
  <section class="container my-5">
    <div id="counter">test counter</div>
    <div id="found">test</div>
  </section>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const NOT_FOUND_URL = window.location.pathname;
      const counterDiv = document.getElementById("counter");
      const foundDiv = document.getElementById("found");

      console.log("404 Page Loaded. Checking for redirects...");
      console.log(`Current URL: ${NOT_FOUND_URL}`);

      try {
        // Fetch the routes JSON file from the root of the website
        console.log("Fetching redirect routes from /static.routes.json...");
        const response = await fetch("/static.routes.json", { cache: "force-cache" });

        if (!response.ok) {
          throw new Error(`Failed to load routes JSON. Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Routes JSON loaded successfully.");

        // Function to escape special characters in the route string
        function escapeRegExp(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // Escape special characters
        }

        // Find a matching route
        const matchedRoute = data.routes.find((routeObj) => {
          try {
            const pattern = new RegExp(`^${escapeRegExp(routeObj.route).replace("\\*", ".*")}$`);
            return pattern.test(NOT_FOUND_URL);
          } catch (regexError) {
            console.error("Invalid regex pattern:", routeObj.route, regexError);
            return false;
          }
        });

        if (matchedRoute) {
          const redirectURL = matchedRoute.redirect;
          let countdown = 0; // Countdown in seconds

          console.log(`Match found! Redirecting to: ${redirectURL}`);

          // Insert a <meta> refresh tag for SEO (Google may respect this)
          const metaRedirect = document.createElement("meta");
          metaRedirect.httpEquiv = "refresh";
          metaRedirect.content = `${countdown};url=${redirectURL}`;
          document.head.appendChild(metaRedirect);
          console.log("Meta refresh tag added for SEO.");

          // Display found message
          foundDiv.innerHTML = `Page not found. Redirecting to <a href="${redirectURL}">${redirectURL}</a> in <span id="countdown">${countdown}</span> seconds...`;
          counterDiv.innerHTML = countdown;

          const countdownInterval = setInterval(() => {
            countdown--;
            counterDiv.innerText = countdown;
            console.log(`Redirecting in ${countdown} seconds...`);

            if (countdown <= 0) {
              clearInterval(countdownInterval);
              console.log(`Redirecting now to: ${redirectURL}`);

              // Use window.location.replace() instead of href to prevent history entry
              window.location.replace(redirectURL);
            }
          }, 1000);
        } else {
          console.log("No matching redirect found.");
          foundDiv.innerHTML = "No redirect found.";
        }
      } catch (error) {
        console.error("Error loading redirect routes:", error);
        foundDiv.innerHTML = "An error occurred while checking for redirects.";
      }
    });
  </script>
{{- end }}

{{- define "template" }}
  page/404.html
{{- end }}
